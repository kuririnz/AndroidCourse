<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>操作性・ユーザ体験の改善 | Android programing getstart</title><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/normalize.css"><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/highlight.css"><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="../../favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="../../." class="title">Android programing getstart</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="../../index.html" class="sidebar-nav-item">Home</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>操作性・ユーザ体験の改善</h1></div></div>
<article><div class="container post"><p>操作性ユーザ体感の改善の中でダイアログやデータベース以外の保存機能を学習します。</p>
<!-- toc -->
<ul>
<li><a href="#学習ポイント">学習ポイント</a></li>
<li><a href="#ユーザ体験の改善">ユーザ体験の改善</a></li>
<li><a href="#データ読み込み中のダイアログ表示機能">データ読み込み中のダイアログ表示機能</a><ul>
<li><a href="#カスタムdialogfragment作成">カスタムDialogFragment作成</a><ul>
<li><a href="#dialogとalertdialog">DialogとAlertDialog</a></li>
</ul>
</li>
<li><a href="#読み込みキャンセル機能">読み込みキャンセル機能</a><ul>
<li><a href="#dialogfragmentのライフサイクル">DialogFragmentのライフサイクル</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#最後に検索した文字列を保持する機能">最後に検索した文字列を保持する機能</a><ul>
<li><a href="#sharedpreference">SharedPreference</a></li>
</ul>
</li>
<li><a href="#androidプロジェクトの整理">Androidプロジェクトの整理</a></li>
</ul>
<!-- tocstop -->
<p><a href="/AndroidCourse/android/09-RefactorFragment">蔵書詳細画面作成</a>からの引き続きの学習ページです。</p>
<h1><span id="学習ポイント">学習ポイント</span></h1><ul>
<li>DialogFragment</li>
<li>SharedPreference</li>
<li>プロジェクトのパッケージ整理</li>
</ul>
<p>Androidアプリでデータ通信中にユーザ操作を受けずにユーザにアプリの状況を伝えるためにダイアログ表示の方法を学習します。<br>また、アプリ内でデータベース以外にデータを保持する方法としてSharedPreferenceの機能を学習します。</p>
<h1><span id="ユーザ体験の改善">ユーザ体験の改善</span></h1><p>前ページまでに実装してきたアプリの中で、データ読み込み中に画面が真っ白になってしまい読み込み時間が長くなるとアプリが止まってしまったと感じてアプリを終了するユーザがいるかもしれません。<br>そこで、アプリが動いていることを通知するためにダイアログ表示を行うように処理を実装していきます。</p>
<h1><span id="データ読み込み中のダイアログ表示機能">データ読み込み中のダイアログ表示機能</span></h1><p>Androidアプリでダイアログを表示するためには<code>DialogFragment</code>クラスを継承したカスタムクラスを作成し、作成したカスタムクラスにどういった内容でダイアログ表示を行うか実装して行く。</p>
<h2><span id="カスタムdialogfragment作成">カスタムDialogFragment作成</span></h2><p>以下の手順から新規javaクラスを作成します。</p>
<blockquote>
<p>New -&gt; Fragment -&gt; Fragment(Blank)</p>
</blockquote>
<img src="/AndroidCourse/android/10-OrganizeExperience/cdialogfrag01.png" width="450" title="Create DialogFragment">
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fragment Name</td>
<td>ProgressDialogFragment</td>
</tr>
<tr>
<td>Create Layout XML?</td>
<td>チェックを<font color="blue">つける</font></td>
</tr>
<tr>
<td>Fragment Layout Name</td>
<td>fragment_progress_dialog</td>
</tr>
<tr>
<td>Include fragment factory methods?</td>
<td>チェックを<font color="red">つけない</font></td>
</tr>
<tr>
<td>Include interface callbacks?</td>
<td>チェックを<font color="red">つけない</font></td>
</tr>
<tr>
<td>Source Language</td>
<td>Java</td>
</tr>
</tbody>
</table>
<p>ダイアログ表示用のFragmentを作成したらレイアウトXMLを修正していきます。<br>LayoutEditor左下から<strong>Text</strong>タブをクリックしテキストエディタを表示し、以下の修正通り修正します。<br>以下レイアウトファイルを表示します。</p>
<blockquote>
<p>app -&gt; res -&gt; layout -&gt; fragment_progress_dialog.xml</p>
</blockquote>
<p>ここでテキストエディタモードでレイアウトを編集するとき、画面右端に表示されている<strong><em>Preview</em></strong>をクリックすると、リアルタイムにプレビューを表示されるので利用してみてください。<br><img src="/AndroidCourse/android/10-OrganizeExperience/prevtextmode.png" width="500" title="Preview in TextEditorMode"><br><figure class="highlight xml"><figcaption><span>fragment_progress_dialog.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓削除↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"kuririnz.xyz.bookdiscovery.ProgressDialogFragment"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- <span class="doctag">TODO:</span> Update blank fragment layout --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/hello_blank_fragment"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑削除↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ProgressBar</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/ProgressCircle"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">"@android:style/Widget.DeviceDefault.Light.ProgressBar.Large"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_margin</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_toRightOf</span>=<span class="string">"@+id/ProgressCircle"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_centerVertical</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_margin</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"書籍情報を検索中..."</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"@color/colorAccent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textAlignment</span>=<span class="string">"center"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑ --&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>ProgressDialogFragment</code>が作成できたらダイアログ表示用のFragmentにするため、親クラスを<strong>DialogFramgnet</strong>に変更します。<br>この<strong>DialogFragment</strong>への変更で気をつけて欲しいのがインポートされるパッケージです。<br>以下のパッケージが追加されていることを確認してください。</p>
<blockquote>
<p>import android.support.v4.app.DialogFragment;</p>
</blockquote>
<figure class="highlight java"><figcaption><span>ProgressDialogFragment.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProgressDialogFragment</span> <span class="keyword">extends</span> <span class="title">DialogFragment</span> </span>&#123;</span><br><span class="line"><span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">    ...一部省略</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// ソフトバックボタンを無効化</span></span><br><span class="line">        getDialog().setCancelable(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        <span class="comment">// Inflate the layout for this fragment</span></span><br><span class="line">        <span class="keyword">return</span> inflater.inflate(R.layout.fragment_progress_dialog, container, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ResultListFragment.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultListFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">AdapterView</span>.<span class="title">OnItemClickListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	...一部省略</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handlerをインスタンス化</span></span><br><span class="line">        handler = <span class="keyword">new</span> Handler();</span><br><span class="line">        <span class="comment">// 検索文字列変数を初期化</span></span><br><span class="line">        term = <span class="string">"Android"</span>;</span><br><span class="line">        <span class="comment">// 連携データが存在するか確認</span></span><br><span class="line">        <span class="keyword">if</span> (getArguments() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 連携データ内から"term"キーのデータを代入、なければ"Android"と文字列を代入</span></span><br><span class="line">            term = getArguments().getString(<span class="string">"term"</span>, <span class="string">"Android"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// プログレスFragmentをインスタンス化</span></span><br><span class="line">        ProgressDialogFragment progressDialog = <span class="keyword">new</span> ProgressDialogFragment();</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">        ...一部省略</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...一部省略</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 検索結果をListViewに反映するメインスレッドの処理クラス</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectResult</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    	...一部省略</span><br><span class="line">        <span class="comment">// Handlerから実行されるメソッド</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">            <span class="comment">// プログレスFragmentを終了させるためにマネージャークラスを取得</span></span><br><span class="line">            FragmentTransaction ft = getChildFragmentManager().beginTransaction();</span><br><span class="line">            <span class="comment">// FragmentManagerに登録されたFragmentからダイアログフラグメントを抽出</span></span><br><span class="line">            ProgressDialogFragment progressDialog = (ProgressDialogFragment) getChildFragmentManager().findFragmentByTag(<span class="string">"Dialog"</span>);</span><br><span class="line">            <span class="comment">// DialogFragmentを取得できた場合</span></span><br><span class="line">            <span class="keyword">if</span> (progressDialog != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ダイアログを非表示にする</span></span><br><span class="line">                progressDialog.dismiss();</span><br><span class="line">                <span class="comment">// FragmentManagerの管理から除外</span></span><br><span class="line">                ft.remove(progressDialog);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// FragmentManagerへの変更を反映(確定)</span></span><br><span class="line">            ft.commit();</span><br><span class="line">            <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ListViewに表示する情報をまとめるAdapterをインスタンス化</span></span><br><span class="line">            adapter = <span class="keyword">new</span> ResultListAdapter(getContext(), resultList);</span><br><span class="line">            <span class="comment">// ListViewに表示情報をまとめたAdapterをセット</span></span><br><span class="line">            resultListView.setAdapter(adapter);</span><br><span class="line">            <span class="comment">// ListViewに行をクリックした時のイベントを登録</span></span><br><span class="line">            resultListView.setOnItemClickListener(ResultListFragment.<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>上記実装が終わったら動作確認してください。<br>検索結果画面へ画面遷移した際に半透過に一部白いウィンドウのダイアログが表示されると思います。</p>
<h3><span id="dialogとalertdialog">DialogとAlertDialog</span></h3><p><code>DialogFragment</code>クラスはDialogクラスのオブジェクトを保持しており、Dialogオブジェクトに生成したレイアウトを表示させます。<br>またDialogには利用方法によって利用するクラスが２種類ありますそれが<strong>Dialog</strong>と<strong>AlertDialog</strong>です。<br>Dialogは開発者が指定したレイアウトを表示するだけで、ユーザへの情報を表示するために利用することが多いと思われます。</p>
<p>AlertDialogは開発者が指定したレイアウトの他に”OK”,”Cancel”などのボタンがメインレイアウトとは別に準備されており、ユーザに応答を求めるときや確認のダイアログとして利用することが多いです。</p>
<h2><span id="読み込みキャンセル機能">読み込みキャンセル機能</span></h2><p>先ほどの実装では検索結果が表示されるまでアプリユーザは何もすることができませんでしたが、読み込み中でも検索画面に戻れるように<code>AlertDialog</code>を使用してキャンセルボタンをダイアログに追加します。<br><figure class="highlight java"><figcaption><span>ProgressDialogFragment.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProgressDialogFragment</span> <span class="keyword">extends</span> <span class="title">DialogFragment</span> </span>&#123;</span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDialog().setCancelable(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// Inflate the layout for this fragment</span></span><br><span class="line">        <span class="keyword">return</span> inflater.inflate(R.layout.fragment_progress_dialog, container, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dialog <span class="title">onCreateDialog</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ダイアログ表示するレイアウトを生成</span></span><br><span class="line">        View view = getActivity().getLayoutInflater().inflate(R.layout.fragment_progress_dialog, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// アラートダイアログビルダーを使ってボタン付きのダイアログを生成</span></span><br><span class="line">        AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getActivity())</span><br><span class="line">                .setView(view)</span><br><span class="line">                .setPositiveButton(<span class="string">"キャンセル"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">                        getActivity().finish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .setCancelable(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 表示するダイアログを生成して返却</span></span><br><span class="line">        <span class="keyword">return</span> builder.create();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><figcaption><span>ResultListFragment.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 検索結果をListViewに反映するメインスレッドの処理クラス</span></span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectResult</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...一部省略</span><br><span class="line">      <span class="comment">// Handlerから実行されるメソッド</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">          <span class="comment">// Activityが終了していたら処理をしない</span></span><br><span class="line">          <span class="keyword">if</span> (getActivity() == <span class="keyword">null</span> || getActivity().isFinishing() || !getActivity().hasWindowFocus()) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">          <span class="comment">// プログレスFragmentを終了させるためにマネージャークラスを取得</span></span><br><span class="line">          FragmentTransaction ft = getChildFragmentManager().beginTransaction();</span><br><span class="line">          <span class="comment">// FragmentManagerに登録されたFragmentからダイアログフラグメントを抽出</span></span><br><span class="line">          ProgressDialogFragment progressDialog = (ProgressDialogFragment) getChildFragmentManager().findFragmentByTag(<span class="string">"Dialog"</span>);</span><br><span class="line">          <span class="comment">// DialogFragmentを取得できた場合</span></span><br><span class="line">          <span class="keyword">if</span> (progressDialog != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// ダイアログを非表示にする</span></span><br><span class="line">              progressDialog.dismiss();</span><br><span class="line">              <span class="comment">// FragmentManagerの管理から除外</span></span><br><span class="line">              ft.remove(progressDialog);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// FragmentManagerへの変更を反映(確定)</span></span><br><span class="line">          ft.commit();</span><br><span class="line">	...一部省略</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>上記コードが実装できたら動作確認してください。<br>読み込み中のダイアログにキャンセルボタンが追加され、キャンセルボタンを押下すると検索画面に戻れるようになっているはずです。</p>
<h3><span id="dialogfragmentのライフサイクル">DialogFragmentのライフサイクル</span></h3><p><code>DialogFragment</code>を使用してダイアログ表示を行う場合に、ライフサイクルが通常のFragmentクラスと少し違うため、注意が必要です。</p>
<p>getLayoutInflater -&gt; onCreateDialog -&gt; onCreateView -&gt; onActivityCreated</p>
<h1><span id="最後に検索した文字列を保持する機能">最後に検索した文字列を保持する機能</span></h1><p>以前にアプリが終了されてもデータが残る機能としてデータベース(Realm)を紹介しましたが、<br>データの量が少ない場合などに手軽に使える機能をAndroidは備えており、容易に使えます。<br>今回は<code>SharedPreference</code>という機能を使い検索した文言を保持する機能を実装していきます。<br><figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// 最後の検索文言を保持/取得するキー定数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String PREF_KEY = <span class="string">"LAST_TERM"</span>;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// レイアウトxmlと関連付けるWidget</span></span><br><span class="line">    <span class="keyword">private</span> Button bookSearchBtn;</span><br><span class="line">    <span class="keyword">private</span> Button historyBtn;</span><br><span class="line">	...一部省略</span><br><span class="line"></span><br><span class="line">	       View.OnClickListener bookSearchEvent = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            	...一部省略</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// Realmインスタンスがちゃんとクローズされること</span></span><br><span class="line">                    realm.close();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">                <span class="comment">// SharedPreferenceに保存</span></span><br><span class="line">                SharedPreferences.Editor editor = MainActivity.<span class="keyword">this</span>.getPreferences(Context.MODE_PRIVATE).edit();</span><br><span class="line">                editor.putString(PREF_KEY, termString).apply();</span><br><span class="line">                <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 検索結果画面へ遷移するためのIntentをインスタンス化</span></span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, ResultListActivity.class);</span><br><span class="line">                <span class="comment">// EditTextに入力された文字列を"KeyValuePair"でResultListActivityに渡す</span></span><br><span class="line">                intent.putExtra(<span class="string">"terms"</span>, termString);</span><br><span class="line">                <span class="comment">// 画面遷移アクションを実行</span></span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">                <span class="comment">// 蔵書検索ボタンが押された時に実行するプログラムをボタンに登録</span></span><br><span class="line">        bookSearchBtn.setOnClickListener(bookSearchEvent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 検索履歴ボタンをクリックした時の処理を実装</span></span><br><span class="line">        historyBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 検索履歴画面へ遷移するためのIntentをインスタンス化</span></span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, HistoryActivity.class);</span><br><span class="line">                <span class="comment">// 画面遷移アクションを実行</span></span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// SharedPreferenceに最後の検索条件が残っていたら登録する</span></span><br><span class="line">        <span class="comment">// SharedPreferenceにデータがない場合は空文字を設定する</span></span><br><span class="line">        String lastTerm = <span class="keyword">this</span>.getPreferences(Context.MODE_PRIVATE).getString(PREF_KEY, <span class="string">""</span>);</span><br><span class="line">        bookSearchEditor.setText(lastTerm);</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">		...一部省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上記コードを実装したら動作確認してください。<br>初回起動時のEditTextは空文字(何も表示されてない)となっており、何かしらの文言で検索を行いアプリを終了させます。<br>改めてアプリを起動したときにEditTextに検索した文言が表示されていることが確認できます。</p>
<h2><span id="sharedpreference">SharedPreference</span></h2><p>Android端末のアプリ専用領域に環境設定としてKey-Value形式でデータを保存/参照できる機能。<br>SharedPreferenceのインスタンス化の引数ではインスタンス化するSharedPreferenceのアクセス許容範囲を指定できます。<br>今回は<code>Context.MODE_PRIVATE</code>ということで自アプリからしかアクセスできないSharedPreferenceを作成し、その中に”LAST_TERM”という鍵[Key]情報に[最後に検索した文字列]というデータ(Value)を保存しました。<br>JSONの概念が理解できている方は<code>{&quot;LAST_TERM&quot;:$term}</code>と保存されている認識で良いと思います。</p>
<p>またSharedPreferenceは名前をつけて複数作成することができ、<strong>JSONファイルを作成してJSON形式でデータを保持している</strong>と思っていただいても良いと思います。</p>
<p>簡単に利用できるSharedPreferenceですが、起動時にメモリ上に読み込む仕様になっているため、大量のSharedPreferenceやデータの保持はアプリの挙動に影響を与える可能性があるので少量で使うようにすることをお勧めします。</p>
<h1><span id="androidプロジェクトの整理">Androidプロジェクトの整理</span></h1><p>ここに至るまでに複数のActivityやFragmentを作成し、類似するネーミングのものも存在するため、ツリー表示が見にくく感じます。<br>そこで作成したファイルごとにパッケージを分けて保存することで探しやすさと視認性をよくしていきます。</p>
<p>このときにマウス操作でドラッグ&amp;ドロップを行うとjavaクラスファイルの格納場所を示すPackage(パッケージ)情報に不整合が発生してしまい、<br>修正が大変になることがあります。<br>Package情報の整合性を保ちつつjavaクラスの格納場所を変更するにはAndroid Studioの<code>Refactor -&gt; Move</code>機能を使って格納場所を変更します。<br>方法としてはまず、分類分けするためのPackageを追加します、このPackageはフォルダとして実態が生成されます。<br><strong>プロジェクトツリーで右クリックから以下を選択</strong></p>
<blockquote>
<p>New -&gt; Package</p>
</blockquote>
<img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage01.png" width="550" title="Organaized Project Package">
<p>続いて作成するPackage名を入力し、<code>OK</code>をクリック<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage02.png" width="450" title="Organaized Project Package"><br>分類用のPackageが作成されたら<strong>プロジェクトツリーで右クリックから以下を選択</strong></p>
<blockquote>
<p>Refactor -&gt; Mode…</p>
</blockquote>
<img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage03.png" width="500" title="Organaized Project Package">
<p>次に移動先を選択するために”To Package”列の<code>...</code>ボタンをクリック<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage04.png" width="500" title="Organaized Project Package"><br>先ほど作成した<code>bookdiscovery.Activity</code>を選択し、<code>OK</code>をクリック<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage05.png" width="500" title="Organaized Project Package"><br><code>bookdiscovery.Activity</code>が選択されていることを確認し、<code>Refactor</code>をクリック<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage06.png" width="500" title="Organaized Project Package"><br>プロジェクトツリー表示を確認すると<code>HistoryActivity.java</code>が<strong>…*.bookdiscovery.Activity</strong>配下に移動します<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage07.png" width="500" title="Organaized Project Package"><br>このときに<code>HistoryActivity.java</code>を参照している<code>MainActivity.java</code>や<code>AndroidManifest.xml</code>ファイルも変更が加わっています。<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage08.png" width="500" title="Organaized Project Package"><br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage09.png" width="500" title="Organaized Project Package"><br>また作業中に以下のようなメッセージが下部のツールエリアに表示されることがありますが、これは置換箇所や深い階層での参照が見つかった場合などに表示されることがあります。<br>置換箇所のプレビューになるのでないように問題がなければ<code>Do Refactor</code>をクリックします<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage10.png" width="500" title="Organaized Project Package"><br>以上の手順でPackageの分割や不整合のないファイル移動を行います。<br>今回は以下の通りに格納されるようにjavaクラスファイルを移動させて見てください<br><img src="/AndroidCourse/android/10-OrganizeExperience/orgpackage10.png" width="500" title="Organaized Project Package"></p>
<p>以上で、操作性・ユーザ体験の改善に関する解説は終了です。</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">kuririnz</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-63175607-3');ga('send','pageview');</script></html>