<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>蔵書検索機能の作成 | Android programing getstart</title><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/normalize.css"><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/highlight.css"><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="../../favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="../../." class="title">Android programing getstart</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="../../index.html" class="sidebar-nav-item">Home</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>蔵書検索機能の作成</h1></div></div>
<article><div class="container post"><p>非同期処理の使い方と解説、インターネット通信ライブラリを利用してインターネット上から取得したデータの利用方法を学習します。</p>
<!-- toc -->
<ul>
<li><a href="#学習ポイント">学習ポイント</a></li>
<li><a href="#非同期処理">非同期処理</a><ul>
<li><a href="#非同期タイマー機能">非同期タイマー機能</a></li>
<li><a href="#handler-クラス">Handler クラス</a></li>
<li><a href="#runnable-インターフェース">Runnable インターフェース</a></li>
</ul>
</li>
<li><a href="#蔵書検索機能">蔵書検索機能</a><ul>
<li><a href="#rest">REST</a></li>
<li><a href="#api">API</a></li>
<li><a href="#okhttpライブラリの導入">OkHttpライブラリの導入</a></li>
<li><a href="#rest-api通信機能">REST API通信機能</a></li>
<li><a href="#検索結果画面データ反映">検索結果画面データ反映</a><ul>
<li><a href="#layoutinflater-クラス">LayoutInflater クラス</a></li>
</ul>
</li>
<li><a href="#入力文字列で蔵書検索する">入力文字列で蔵書検索する</a></li>
</ul>
</li>
<li><a href="#プログラム課題">プログラム課題</a></li>
</ul>
<!-- tocstop -->
<p><a href="/AndroidCourse/android/06-TransitionScreen">検索結果一覧画面の作成</a>からの引き続きの学習ページです。</p>
<h1><span id="学習ポイント">学習ポイント</span></h1><ul>
<li>非同期通信の概要</li>
<li>Androidアプリ開発におけるUIスレッド(メインスレッド)とサブスレッド</li>
<li>REST API</li>
<li>インターネット通信ライブラリ<strong>OkHttp</strong>の利用方法</li>
</ul>
<p>Googleが公開している蔵書検索サービスの”Google Books API”を利用して入力された文言を元にインターネット上の蔵書情報を検索し、アプリの検索結果情報を表示します。<br>REST API通信を行う上で非同期処理の基礎知識が必要になりますので合わせて学習します。</p>
<h1><span id="非同期処理">非同期処理</span></h1><p>アプリ開発における非同期処理とは画面の表示や操作に影響なく別のプログラムや命令を実行することを指します。<br>身近なものとしてプッシュ通知やアラーム機能も非同期処理の一部と言えます。</p>
<p>Androidアプリにはスレッド(Thread)という概念があり、”タスク”や”一連の仕事”と言い換えることができます。<br>Androidのアプリを起動した時に<code>activity_main.xml</code>のレイアウトが表示されるのも一つのスレッドでプログラムを実行した結果です。</p>
<p>この画面にレイアウトを表示するスレッドを<strong>メインスレッド</strong>と呼びます。<br>メインスレッドは最初に表示されるアクティビティクラスを判別すると<font color="red">自動的に作成</font>されます。</p>
<p>メインスレッドはウィジェットやビューの表示や更新を行える唯一のスレッドなため<strong>UIスレッド</strong>と呼ぶこともあります、そしてメインスレッドは表示の管理に加えてユーザの操作（タップやスワイプ）を監視する仕事も兼務しています。</p>
<p>プログラムの上での非同期処理は主に<strong>メインスレッド</strong>に影響が無いようにプログラムを実行することを指します、<br>そのために別のスレッドを<font color="red">自分で作成</font>し、その領域でプログラムを実行します。<br>自分で作成したスレッドは<strong>サブスレッド</strong>と呼び、複数のサブスレッドを作成することができます。</p>
<p>最終的な目的としてインターネット上のデータをアプリで取得することにあります。<br>Androidアプリは画面の表示やユーザ操作に影響がある可能性がある時間のかかる命令をメインスレッドで実行することを禁止しています。<br>インターネット通信処理も時間のかかる命令であるため、メインスレッドでの実装を禁止されています、<br>そのため、インターネット通信処理も非同期処理として実行する必要があります。</p>
<p>インターネット通信の実装と非同期処理を同時に進めてしまうと情報を整理できない場合もあるのでまずは非同期処理に絞って学習していきます。</p>
<h2><span id="非同期タイマー機能">非同期タイマー機能</span></h2><p>非同期処理の基礎を学習するために、準備されているタイマースレッドというサブスレッドを使って画面が表示されてから3秒ごとに、入力されたテキストをログ出力するプログラムを作っていきます。<br><figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line"><span class="comment">// レイアウトxmlと関連付けるWidget</span></span><br><span class="line"><span class="keyword">private</span> Button bookSearchBtn;</span><br><span class="line"><span class="keyword">private</span> EditText bookSearchEditor;</span><br><span class="line"><span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"><span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line"><span class="comment">// Timerスレッドクラス</span></span><br><span class="line"><span class="keyword">private</span> Timer timer;</span><br><span class="line"><span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 蔵書検索ボタンをjavaプログラムで操作できるように名前をつける</span></span><br><span class="line">    bookSearchBtn = findViewById(R.id.BookSearchBtn);</span><br><span class="line">    <span class="comment">// 蔵書検索する文字を入力するEditTextをjavaプログラムで操作できるように名前をつける</span></span><br><span class="line">    bookSearchEditor = findViewById(R.id.BookSearchEdit);</span><br><span class="line">    <span class="comment">// 蔵書検索ボタンが押された時の処理を実装</span></span><br><span class="line">    View.OnClickListener bookSearchEvent = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// コンソールログにボタンが押されたことを出力(表示)</span></span><br><span class="line">            Log.d(<span class="string">"BookSearchBtn"</span>, <span class="string">"onClick: BookSearch Button"</span>);</span><br><span class="line">            <span class="comment">// 入力された文字をToast(トースト)に表示</span></span><br><span class="line">            Toast.makeText(getBaseContext()</span><br><span class="line">                    , <span class="string">"入力された文字は ["</span> + bookSearchEditor.getText().toString() + <span class="string">"]です。"</span></span><br><span class="line">                    , Toast.LENGTH_LONG).show();</span><br><span class="line">            <span class="comment">// 画面遷移するためのIntentをインスタンス化</span></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, ResultListActivity.class);</span><br><span class="line">            <span class="comment">// 画面遷移アクションを実行</span></span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 蔵書検索ボタンが押された時に実行するプログラムをボタンに登録</span></span><br><span class="line">    bookSearchBtn.setOnClickListener(bookSearchEvent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// 準備されているTimerスレッドをインスタンス化</span></span><br><span class="line">    timer = <span class="keyword">new</span> Timer();</span><br><span class="line">    <span class="comment">// ３秒ごとに実行するタスク(TimerTask)をインスタンス化</span></span><br><span class="line">    TimerTask timerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// コンソールログに更新された内容を出力</span></span><br><span class="line">            Log.d(<span class="string">"SubThread Process"</span></span><br><span class="line">                    , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Timerスレッドの実行スケジュールを設定</span></span><br><span class="line">    <span class="comment">// 3秒毎にtimerTaskのプログラムを実行</span></span><br><span class="line">    timer.schedule(timerTask, <span class="number">0</span>, <span class="number">3000</span>);</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>コードを実装したらエミュレータを起動して確認します。<br>下図の通りAndroid Studioの<strong>Logcat</strong>で確認すると3秒毎にログが出力を確認できましたか？<br><img src="/AndroidCourse/android/07-AsyncProcess/timerexample.png" width="650" title="example timer log"></p>
<p>次は画面が表示されてから3秒後から3秒毎にトーストが表示される様に修正してみます。<br><figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">   ...一部省略</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 蔵書検索ボタンが押された時に実行するプログラムをボタンに登録</span></span><br><span class="line">    bookSearchBtn.setOnClickListener(bookSearchEvent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 準備されているTimerスレッドをインスタンス化</span></span><br><span class="line">    timer = <span class="keyword">new</span> Timer();</span><br><span class="line">    <span class="comment">// ３秒ごとに実行するタスク(TimerTask)をインスタンス化</span></span><br><span class="line">    TimerTask timerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// コンソールログに更新された内容を出力</span></span><br><span class="line">            Log.d(<span class="string">"SubThread Process"</span></span><br><span class="line">                    , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span>);</span><br><span class="line">            <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">            <span class="comment">// 更新された内容をトーストに表示</span></span><br><span class="line">            Toast.makeText(getBaseContext()</span><br><span class="line">                    , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span></span><br><span class="line">                    , Toast.LENGTH_SHORT).show();</span><br><span class="line">            <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Timerスレッドの実行スケジュールを設定</span></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// 画面が表示されてから3秒後から3秒毎にtimerTaskのプログラムを実行</span></span><br><span class="line">    timer.schedule(timerTask, <span class="number">3000</span>, <span class="number">3000</span>);</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>コードの実装が終わったら<code>Run</code>ボタンからエミュレータで動作を確認します。<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>アプリが強制終了してしまったのではないでしょうか？<br>紹介した通りメインスレッド以外のスレッドでは表示や更新は実行できません、<br>それに対して上記はTimerスレッドの領域でToastを表示するコードを実装してしまい、アプリ実行時に強制終了してしまいました。<br>強制終了した原因などログは<code>Logcat</code>領域に表示されるので確認して見ましょう。<br><img src="/AndroidCourse/android/07-AsyncProcess/MainThreadError.png" title="ThreadSequence"><br>プログラム実行時に発生したエラーメッセージは赤文字で表示されます。<br>先ほどのエラー原因を説明している箇所は以下</p>
<blockquote>
<font color="red">java.lang.RuntimeException: Can’t create handler inside thread that has not called Looper.prepare()</font>

</blockquote>
<p>以降の行の”at …”は強制終了する前に実行されたメソッドなど命令が順に表示されます。<br>各行後半の “()” 内はプログラムのファイル名とプログラムを実行した行数が表示され、クリックするとプログラムファイルが表示されます。<br>以下の行のエラーメッセージ上で “()” 内が青くなっています、これは自分で管理するファイルであることを表しており、<br>多くの場合にエラーの原因になったプログラムの行を示している箇所となります。</p>
<blockquote>
<font color="red">at kuririnz.xyz.bookdiscovery.MainActivity$2.run(</font><font color="blue">MainActivity.java:53</font><font color="red">)</font>

</blockquote>
<p>エラーが発生した時には原因や問題を解析するためには<code>Logcat</code>を確認する癖を付けましょう！<br>コードを修正する前に新しく使う<strong>Handlerクラス</strong>と<strong>Runnableインターフェース</strong>を紹介します。</p>
<h2><span id="handler-クラス">Handler クラス</span></h2><p>Handlerクラスはスレッドから別のスレッドへ通信を行う機能を持ったクラスです。<br>今回のプログラムではToastを画面に表示する為TimerThreadからMainThreadへ通信を行います。<br>通信と記述していますが、今回の通信ではMainThreadでToastを表示することが目的になるため、<br>データを渡すことが目的の通信では無いことを意識してみてみてください。</p>
<h2><span id="runnable-インターフェース">Runnable インターフェース</span></h2><p>RunnableはThreadで処理する領域を宣言し、Thread内のプログラムを実装、実行する機能を持っています。<br><strong>Thread = Runnable</strong>と認識して問題ありません。<br>今回のプログラムではTimerThreadで３秒ごとにlogを出力する時、MainThreadでToastを表示する処理を実行する時にRunnableインターフェースを使用しています。</p>
<p>では改めてタイマースレッドからメインスレッドに作業を渡して画面にトースト表示するよう修正します。<br><figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// レイアウトxmlと関連付けるWidget</span></span><br><span class="line">    <span class="keyword">private</span> Button bookSearchBtn;</span><br><span class="line">    <span class="keyword">private</span> EditText bookSearchEditor;</span><br><span class="line">    <span class="comment">// Timerクラス</span></span><br><span class="line">    <span class="keyword">private</span> Timer timer;</span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// メインスレッドに帰って来るためのハンドラー</span></span><br><span class="line">    <span class="keyword">private</span> Handler handler;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// ハンドラーオブジェクトをMainThreadでインスタンス化</span></span><br><span class="line">        handler = <span class="keyword">new</span> Handler();</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        <span class="comment">// 蔵書検索ボタンをjavaプログラムで操作できるように名前をつける</span></span><br><span class="line">        bookSearchBtn = findViewById(R.id.BookSearchBtn);</span><br><span class="line">        <span class="comment">// 蔵書検索する文字を入力するEditTextをjavaプログラムで操作できるように名前をつける</span></span><br><span class="line">        bookSearchEditor = findViewById(R.id.BookSearchEdit);</span><br><span class="line">        <span class="comment">// 蔵書検索ボタンが押された時の処理を実装</span></span><br><span class="line">        View.OnClickListener bookSearchEvent = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// コンソールログにボタンが押されたことを出力(表示)</span></span><br><span class="line">                Log.d(<span class="string">"BookSearchBtn"</span>, <span class="string">"onClick: BookSearch Button"</span>);</span><br><span class="line">                <span class="comment">// 入力された文字をToast(トースト)に表示</span></span><br><span class="line">                Toast.makeText(getBaseContext()</span><br><span class="line">                        , <span class="string">"入力された文字は ["</span> + bookSearchEditor.getText().toString() + <span class="string">"]です。"</span></span><br><span class="line">                        , Toast.LENGTH_LONG).show();</span><br><span class="line">                <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">                <span class="comment">// Timerスレッドを止める</span></span><br><span class="line">                timer.cancel();</span><br><span class="line">                <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">                <span class="comment">// 画面遷移するためのIntentをインスタンス化</span></span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, ResultListActivity.class);</span><br><span class="line">                <span class="comment">// 画面遷移アクションを実行</span></span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 蔵書検索ボタンが押された時に実行するプログラムをボタンに登録</span></span><br><span class="line">        bookSearchBtn.setOnClickListener(bookSearchEvent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定期実行するタスク(TimerTask)をインスタンス化</span></span><br><span class="line">        TimerTask timerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// コンソールログに更新された内容を出力</span></span><br><span class="line">                Log.d(<span class="string">"SubThread Process"</span></span><br><span class="line">                        , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span>);</span><br><span class="line">                <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">                handler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 更新された内容をトーストに表示</span></span><br><span class="line">                        Toast.makeText(getBaseContext()</span><br><span class="line">                                , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span></span><br><span class="line">                                , Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上記コードを実装できたら、エミュレータで確認します。<br>以下の様に3秒ごとに入力中の文字がToastに表示されたでしょうか？<br><img src="/AndroidCourse/android/07-AsyncProcess/AsyncTimerToast.png" width="300" title="TimerThreadTest"><br>Handlerクラスを使いタイマースレッドからメインスレッドに戻ることができました。<br>実感は湧きにくいかもしれませんが、画面にToastが表示されたことが何よりの結果です。</p>
<p>サブスレッドからメインスレッドに戻るためにはHandlerクラスをインスタンス化するタイミング、または方法を意識しないといけません。<br>”onCreate()”メソッドはメインスレッドで実行されています、そのため “onCreate()”メソッド内でインスタンス化した<code>handler</code>はメインスレッドの属性を持ったことになり、サブスレッドから<code>handler.post(...)</code>実行したRunnableのプログラムはメインスレッドでのプログラムとして扱われたことになります。</p>
<p>以上で、非同期処理の基礎の解説は終了です、難しい箇所も多いので自分なりにプログラムを修正して試してみてください。</p>
<h1><span id="蔵書検索機能">蔵書検索機能</span></h1><p>非同期処理の基礎を学んだところで、本命のインターネット上にあるデータを取得するプログラムを実装していきます。<br>今回のアプリは蔵書検索する機能を実装するためにインターネット上にあるデータが必要になりますが、その問題を解決するために “Google Books API”サービスを使いインターネット上からデータを取得する機能を実装していきます。</p>
<p>REST APIとは<strong>Representational State Transfer Application Programming Interface</strong>の略称で<br>さらにそれぞれ”REST”と”API”で使われることもあります。</p>
<h2><span id="rest">REST</span></h2><p>Webサービスの設計モデルを表しており、REST APIのURLにHTTPメソッドでアクセスすることでデータの送受信が行えます。</p>
<p>RESTの設計条件として以下が該当します。<br><blockquote><ul>
<li>アドレス指定可能なURLで公開されていること</li>
<li>インターフェースが統一されていること(HTTPメソッドに準じていること)</li>
<li>ステートレスであること</li>
<li>処理結果がHTTPステータスコードで通知されること</li>
</ul>
<footer><strong>Qiita</strong><cite><a href="https://qiita.com/TakahiRoyte/items/949f4e88caecb02119aa" target="_blank" rel="external">REST入門 基礎知識</a></cite></footer></blockquote></p>
<h2><span id="api">API</span></h2><p>ウィキペディアには以下の様にあります。<br><blockquote><p><strong>ソフトウェアコンポーネントが互いにやり取りするのに使用するインターフェース仕様</strong></p>
<footer><strong>wikipedia</strong><cite><a href="https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9" target="_blank" rel="external">API</a></cite></footer></blockquote><br>…文章からイメージするのは難しそうです。。。<br>ですので、まずは以下の様な認識で使っていきましょう。</p>
<font color="blue"><strong>インターネット上に公開された、URLを知っていれば誰でも使えるデータ</strong></font>

<p>例として実際にAPIのデータをgoogle ChromeなどWebブラウザで確認できるので確認してみましょう。<br>以下で紹介しているURLはgoogleが一般公開している”google books API”というREST APIで、蔵書の情報を取得することができるAPIです。<br>また、Google Books APIを使うためには “?q=***“という検索条件を必ずつけないといけないのでサンプルで参考書タイトルで検索する指定しています。<br><blockquote><p><a href="https://www.googleapis.com/books/v1/volumes?q=ほんきで学ぶAndroidアプリ開発入門" target="_blank" rel="external">https://www.googleapis.com/books/v1/volumes?q=ほんきで学ぶAndroidアプリ開発入門</a></p>
<footer><strong>Google Books APIs</strong><cite><a href="https://developers.google.com/books/docs/v1/using" target="_blank" rel="external">Reference</a></cite></footer></blockquote><br>この画面に表示されているデータは<code>json</code>という形式でまとめられたデータで、上記URLにアプリからアクセスすると<br>画面に表示されているデータをアプリで受け取ることができます。<br>キュレーションアプリやニュースアプリなどはこの様にデータを取得して画面に表示させてなどしています。</p>
<p>Google Books APIでは”?q=***“の”*“の文字を変更することで表示される結果が変わります、<br>これはホームページなどと同じくサーバがURLを受け取り、サーバ内のプログラムが実行された結果<code>json</code>データが返されているからです。</p>
<p>上記で紹介したAPIの検索条件等は<a href="https://developers.google.com/books/docs/v1/using#WorkingVolumes" target="_blank" rel="external">Google Books APIs</a>に記載されています。（全て英語です）</p>
<p>下図はREST API通信を行う流れからデータを取得し、画面に反映するまでの簡単な流れを示しています。<br><img src="/AndroidCourse/android/07-AsyncProcess/APISequence.svg" width="550" title="APISequence"></p>
<p>Andoridアプリでは画面表示や更新はMainThreadのみ可能と解説をしましたが、更に<font color="blue"><strong>MainThreadは時間のかかる処理を行なってはいけない</strong></font>という制約もあるため、MainThreadでネットワーク通信を行うとアプリが強制終了してしまいます。</p>
<p>上記の図の通りですが<font color="red"><strong>REST API通信を実行し、画面に反映するためには大まかに以下の手順が必要になります</strong></font></p>
<ol>
<li>メインスレッドでハンドラーをインスタンス化</li>
<li>メインスレッドからサブスレッドを起動</li>
<li>サブスレッドでAPI通信処理を実行し検索結果データを取得</li>
<li>ハンドラーを使いサブスレッドで取得したAPIで取得した検索結果データをメインスレッドへ連携</li>
<li>メインスレッドで検索結果データを使い画面を更新</li>
</ol>
<h2><span id="okhttpライブラリの導入">OkHttpライブラリの導入</span></h2><p>REST API通信、ネットワーク通信処理を行うために、ここでは<strong><a href="http://square.github.io/okhttp/" target="_blank" rel="external">OkHttp</a></strong>という<em>ライブラリ</em>を使っていきます、<strong>OkHttp</strong>はAndroid に元々備わっているネットワーク通信機能をさらに簡単に実装することができる機能群です。<br>このようにプログラムを一部簡単にしてくれる機能群を<em>ライブラリ</em>と呼びます。</p>
<p><strong>OkHttp</strong>を導入するために修正するファイルは<code>build.gradle</code>というファイルです。<br>このファイルは２つありますが、開くのは<code>build.gradle</code>の後ろに<strong><em>(Module: app)</em></strong>と表示されている方です。<br><img src="/AndroidCourse/android/07-AsyncProcess/includeokHttp01.png" width="550" title="IncludeokHttp"><br><code>build.gradle</code>を開き “dependencies” の “{}”内に以下のコードを記述します<br><figure class="highlight gradle"><figcaption><span>build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...一部省略</span><br><span class="line">    implementation <span class="string">'com.squareup.okhttp3:okhttp:3.9.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>コードの記述が終わったら右上に表示された<font color="blue">Sync Now</font>リンクをクリックします。<br><img src="/AndroidCourse/android/07-AsyncProcess/includeokHttp02.png" width="600" title="Include okHttp"><br>これで<strong>OkHttp</strong>ライブラリの導入は完了です。</p>
<h2><span id="rest-api通信機能">REST API通信機能</span></h2><p><strong>OkHttp</strong>の導入が完了しましたので、実際にアプリで使っていきます！<br>実装の完成形として<code>MainActivity</code>の蔵書検索ボタンがクリックされたらEditTextの文字データを<code>ResultListActivity</code>に渡します。<br>そして<code>ResultListActivity</code>では受け取った文字データをGoogle Books APIから検索する蔵書情報として利用して期待する検索結果をインターネット上から取得します。<br>画面への反映は次のページで解説します。</p>
<p>javaファイルの実装の前にAndroidアプリでインターネット通信を行うためには、パーミッション(permission)と呼ばれる許可設定が必要なので<code>AndroidManifest.xml</code>ファイルを修正します。<br><figure class="highlight xml"><figcaption><span>AndroidManifest.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"PackageName"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Androidアプリでインターネット通信を許可する設定 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span>一部省略&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>ではjavaファイルの実装です、まずはアプリでGoogle Books APIを使ってデータを取得するプログラムを実装します。<br><figure class="highlight java"><figcaption><span>ResultListActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">...一部省略</span><br><span class="line"><span class="comment">// ListViewの表示内容を管理するクラス</span></span><br><span class="line"><span class="keyword">private</span> ResultListAdapter adapter;</span><br><span class="line"><span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line"><span class="comment">// OkHttp通信クライアント</span></span><br><span class="line"><span class="keyword">private</span> OkHttpClient okHttpClient;</span><br><span class="line"><span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    ...一部省略</span><br><span class="line">    <span class="comment">// ListViewに行をクリックした時のイベントを登録</span></span><br><span class="line">    resultListView.setOnItemClickListener(ResultListActivity.<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// OkHttp通信クライアントをインスタンス化</span></span><br><span class="line">    okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    <span class="comment">// 通信するための情報</span></span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder().url(<span class="string">"https://www.googleapis.com/books/v1/volumes?q=ほんきで学ぶAndroidアプリ開発入門"</span>).build();</span><br><span class="line">    <span class="comment">// データの取得後の命令を実装</span></span><br><span class="line">    Callback callBack = <span class="keyword">new</span> Callback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 失敗した時の命令</span></span><br><span class="line">            <span class="comment">// 通信に失敗した原因をログに出力</span></span><br><span class="line">            Log.e(<span class="string">"failure API Response"</span>, e.getLocalizedMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="comment">// 成功した時の命令</span></span><br><span class="line">            <span class="comment">// Google Books APIから取得したデータをログに出力</span></span><br><span class="line">            Log.d(<span class="string">"Success API Response"</span>, response.body().string());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 非同期処理でREST API通信を実行</span></span><br><span class="line">    okHttpClient.newCall(request).enqueue(callBack);</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上記コードを実装したら動作確認してみましょう。<br><code>Logcat</code>にwebブラウザで確認したデータが表示されたでしょうか？<br>表示されていれば正常にインターネット上からデータを取得できたことになります。<br><img src="/AndroidCourse/android/07-AsyncProcess/apiresponse.png" width="700" title="API Response Log"><br>上記コードで出てきましたが、以下の様にメソッドからメソッドを呼び出す様な方法を<strong>メソッドチェーン</strong>と呼びます、プログラムの設計次第ではの様な実装方法も可能ですが、自作するクラスでは使う機会は少ないですが、今回の様にライブラリではよく使われる実装パターンなので覚えておきましょう。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Request request = <span class="keyword">new</span> Request.Builder().url(<span class="string">""</span>).build();</span><br><span class="line">や</span><br><span class="line">okHttpClient.newCall(request).enqueue(...)</span><br></pre></td></tr></table></figure></p>
<p>取得した蔵書データですがWebブラウザで確認した形式と同じく<code>Json</code>形式で取得しました。<br>Jsonはシンプルなデータ形式で <strong>:(コロン)</strong>を挟む左にデータの名称、右にデータが記述されており、複数データがある場合は<strong>,(カンマ)</strong>で区切って複数のデータを持つことができます。<br>Jsonデータは必ず<strong>{}(波括弧)</strong>で閉じられています。<br>この様に名称とデータを合わせて持つデータを<strong>KeyValuePair</strong>や<strong>KeyValue形式</strong>データと呼びます。<br>以下の例では”AndroidCourse”というKey(名称)に”Androidアプリの開発講座”というValue(文字列データ)が関連づいた<strong>KeyValue</strong>データです。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"AndroidCourse"</span>:<span class="string">"Androidアプリの開発講座"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Jsonのデータには文字列や数値、配列や真偽値などを設定することが可能です。<br>REST APIを使う場合の多くはこのJson形式でデータを取得することが多いので解析できる様に覚えておくと便利です。</p>
<p>次に取得したデータをアプリ内でパース(解析)して取得した蔵書データの件数と件数分のタイトルをログに出力してみます。<br><figure class="highlight java"><figcaption><span>ResultListActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">...一部省略</span><br><span class="line"><span class="comment">// OkHttp通信クライアントをインスタンス化</span></span><br><span class="line">okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"><span class="comment">// 通信するための情報</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder().url(<span class="string">"https://www.googleapis.com/books/v1/volumes?q=ほんきで学ぶAndroidアプリ開発入門"</span>).build();</span><br><span class="line"><span class="comment">// データの取得後の命令を実装</span></span><br><span class="line">Callback callBack = <span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 失敗した時の命令</span></span><br><span class="line">        <span class="comment">// 通信に失敗した原因をログに出力</span></span><br><span class="line">        Log.e(<span class="string">"failure API Response"</span>, e.getLocalizedMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 成功した時の命令</span></span><br><span class="line">        <span class="comment">// Google Books APIから取得したデータをログに出力</span></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// Jsonのパースが失敗してアプリの強制終了を回避する機能</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// JsonデータをJSONObjectに変換</span></span><br><span class="line">            JSONObject rootJson = <span class="keyword">new</span> JSONObject(response.body().string());</span><br><span class="line">            <span class="comment">// Jsonデータから蔵書リストデータ"items"を取得</span></span><br><span class="line">            JSONArray items = rootJson.getJSONArray(<span class="string">"items"</span>);</span><br><span class="line">            Log.d(<span class="string">"Success API Response"</span>, <span class="string">"APIから取得したデータの件数:"</span> +</span><br><span class="line">                    items.length());</span><br><span class="line">            <span class="comment">// 蔵書リストの件数分繰り返しタイトルをログ出力する</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; items.length(); i ++) &#123;</span><br><span class="line">                <span class="comment">// 蔵書リストから i番目のデータを取得</span></span><br><span class="line">                JSONObject item = items.getJSONObject(i);</span><br><span class="line">                <span class="comment">// 蔵書のi番目データから蔵書情報のグループを取得</span></span><br><span class="line">                JSONObject volumeInfo = item.getJSONObject(<span class="string">"volumeInfo"</span>);</span><br><span class="line">                <span class="comment">// 繰り返しの番号と蔵書のタイトルをログに出力</span></span><br><span class="line">                Log.d(<span class="string">"Response Item Title"</span>, (i + <span class="number">1</span>) + <span class="string">"番目のデータタイトル："</span> + volumeInfo.getString(<span class="string">"title"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            <span class="comment">// Jsonパースの時にエラーが発生したらログに出力する</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 非同期処理でREST API通信を実行</span></span><br><span class="line">okHttpClient.newCall(request).enqueue(callBack);</span><br></pre></td></tr></table></figure></p>
<p>上記コードを実装したら動作確認します。</p>
<p>Json形式のデータはプログラムにおいて文字列データです。<br>文字列の形式を元に<strong>KeyValue</strong>データとしてパース(解析)するために<code>JSONObject</code>クラス、配列の場合は<code>JSONArray</code>クラスを使って実装します。<br>まずはJson形式文字列を<code>JSONObject</code>のインスタンス化する時の引数にセットすることで、<br><code>JSONObject</code>は引数のJson形式文字列データを<strong>KeyValue</strong>形式の<code>JSONObject</code>に変換します、今回のコードでは下記の１行が該当します。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JSONObject rootJson = <span class="keyword">new</span> JSONObject(response.body().string());</span><br></pre></td></tr></table></figure></p>
<p>次に<strong>KeyValue</strong>データのKey情報を使って <em>“title”</em>のデータを取得していきます。<br>そのための階層をWebブラウザで確認すると<br><img src="/AndroidCourse/android/07-AsyncProcess/jsonparse.png" width="500" title="Json Parse"></p>
<blockquote>
<p>{}(rootObject) -&gt; items(JSONArray) -&gt; volumeInfo(JSONObject) -&gt; title(String)</p>
</blockquote>
<p>の位置に表示されているのがわかりますので順次１階層毎に参照していきます。<br>１階層下の子要素を参照するメソッドは各データ型毎に用意されており、間違ったメソッドで参照すると正常に解析できず強制終了してしまいます。<br>ですがjava言語も優しさは残っており、予期せぬ不具合を検知する機能として<code>try〜catch</code>構文という強制終了を防ぐプログラムの記述方法があり、上記のコードはそれを適用しています。<br><code>try {}</code>の波括弧内に不具合が発生しそうなコードを実装し、後ろの<code>catch() {}</code>で不具合が発生した時に実行するコードを記述することができます。<br><code>catch()</code>の引数には発生しそうな不具合の種類を指定しなければならず、今回は”JSONException”とJSONのパースに失敗した時に不具合をキャッチしてくれます。</p>
<h2><span id="検索結果画面データ反映">検索結果画面データ反映</span></h2><p>データの解析方法まで試せましたが、「インターネット通信はMainThreadではできなかったんじゃないの？」と感じた方もいるかもしれません。<br>通信処理を実行した以下の<code>enqueue()</code>メソッドでサブスレッドを起動しているのです、開発側すら非同期を気にせず通信が実装できてしまいました。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">okHttpClient.newCall(request).enqueue(callBack);</span><br></pre></td></tr></table></figure></p>
<p>サブスレッド通信であるので通信後のCallBackもサブスレッドで実行します、そのため<code>CallBack &gt; onResponse()</code>メソッド内でListViewを更新することはできません。<br>ここで “Handler”クラスが必要になります。<br>ここからの実装で”onResponse()”メソッドからメインスレッドにデータを連携しListViewに反映していきます。<br><figure class="highlight java"><figcaption><span>ResultListAdapter.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultListAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ListViewの描画に必要な変数を宣言</span></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; titleList;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; summaryList;</span><br><span class="line">    <span class="keyword">private</span> LayoutInflater layoutInflater;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// コンストラクタ(インスタンス時に呼び出されるメソッドのようなもの)</span></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResultListAdapter</span><span class="params">(Context context, List&lt;String&gt; titleList, List&lt;String&gt; summaryList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.titleList = titleList;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        <span class="keyword">this</span>.summaryList = summaryList;</span><br><span class="line">        <span class="keyword">this</span>.layoutInflater = LayoutInflater.from(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 一覧表示する要素数を返却する</span></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="keyword">return</span> titleList.size();</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...一部省略</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> i, View view, ViewGroup viewGroup)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 各行の表示レイアウト読み込みや、描画情報の設定を実装する</span></span><br><span class="line">        <span class="comment">// getViewで返却されたViewがListViewに表示される</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// viewの中身が空かチェック</span></span><br><span class="line">        <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// viewがレイアウトを読み込んでいない場合は"row_result_list"を読み込む</span></span><br><span class="line">            view = layoutInflater.inflate(R.layout.row_result_list, viewGroup, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// row_result_listのTitleとSummaryに文言を代入</span></span><br><span class="line">        TextView titleView = view.findViewById(R.id.RowListTitle);</span><br><span class="line">        TextView summaryView = view.findViewById(R.id.RowListSummary);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        titleView.setText(titleList.get(i));</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        summaryView.setText(summaryList.get(i));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文字情報を代入されたviewを返却</span></span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><figcaption><span>ResultListActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultListActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">AdapterView</span>.<span class="title">OnItemClickListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    ...一部省略</span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓削除↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// 検証用コレクションデータ</span></span><br><span class="line">    List&lt;String&gt; listData = Arrays.asList(<span class="string">"Android アプリ開発の環境構築"</span></span><br><span class="line">            , <span class="string">"Android OS とは"</span></span><br><span class="line">            , <span class="string">"Androidの概念"</span></span><br><span class="line">            , <span class="string">"Androidアプリ開発を始める"</span></span><br><span class="line">            , <span class="string">"検索画面レイアウト作成"</span></span><br><span class="line">            , <span class="string">"ボタンイベントの実装"</span></span><br><span class="line">            , <span class="string">"検索結果画面への遷移実装"</span></span><br><span class="line">            , <span class="string">"非同期処理、REST API通信の実装"</span></span><br><span class="line">            , <span class="string">"検索履歴機能"</span></span><br><span class="line">            , <span class="string">"Firebase導入"</span>);</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑削除↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">    <span class="comment">// ListViewの表示内容を管理するクラス</span></span><br><span class="line">    <span class="keyword">private</span> ResultListAdapter adapter;</span><br><span class="line">    <span class="comment">// OkHttp通信クライアント</span></span><br><span class="line">    <span class="keyword">private</span> OkHttpClient okHttpClient;</span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// メインスレッドに戻ってくるためのHandler</span></span><br><span class="line">    <span class="keyword">private</span> Handler handler;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_result_list);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// Handlerをインスタンス化</span></span><br><span class="line">        handler = <span class="keyword">new</span> Handler();</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        <span class="comment">// xmlファイルのコンポーネントと関連付け</span></span><br><span class="line">        resultListView = findViewById(R.id.ResultListView);</span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓削除↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// ListViewに表示する情報をまとめるAdapterをインスタンス化</span></span><br><span class="line">        adapter = <span class="keyword">new</span> ResultListAdapter(ResultListActivity.<span class="keyword">this</span>, listData);</span><br><span class="line">        <span class="comment">// ListViewに表示情報をまとめたAdapterをセット</span></span><br><span class="line">        resultListView.setAdapter(adapter);</span><br><span class="line">        <span class="comment">// ListViewに行をクリックした時のイベントを登録</span></span><br><span class="line">        resultListView.setOnItemClickListener(ResultListActivity.<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑削除↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">        ...一部省略</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// 成功した時の命令</span></span><br><span class="line">                <span class="comment">// Google Books APIから取得したデータをログに出力</span></span><br><span class="line">                <span class="comment">// Jsonのパースが失敗してアプリの強制終了を回避する機能</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// JsonデータをJSONObjectに変換</span></span><br><span class="line">                    JSONObject rootJson = <span class="keyword">new</span> JSONObject(response.body().string());</span><br><span class="line">                    <span class="comment">// Jsonデータから蔵書リストデータ"items"を取得</span></span><br><span class="line">                    JSONArray items = rootJson.getJSONArray(<span class="string">"items"</span>);</span><br><span class="line">                    Log.d(<span class="string">"Success API Response"</span>, <span class="string">"APIから取得したデータの件数:"</span> +</span><br><span class="line">                            items.length());</span><br><span class="line">                    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">                    <span class="comment">// メインスレッドで実行する処理をインスタンス化</span></span><br><span class="line">                    ReflectResult reflectResult = <span class="keyword">new</span> ReflectResult(items);</span><br><span class="line">                    <span class="comment">// Handlerにてメインスレッドに処理を戻し、ReflectResultのrunメソッドを実行する</span></span><br><span class="line">                    handler.post(reflectResult);</span><br><span class="line">                    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">                    <span class="comment">// Jsonパースの時にエラーが発生したらログに出力する</span></span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 非同期処理でREST API通信を実行</span></span><br><span class="line">        okHttpClient.newCall(request).enqueue(callBack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...一部省略</span><br><span class="line"></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// 検索結果をListViewに反映するメインスレッドの処理クラス</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectResult</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 蔵書一覧タイトルデータリスト</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; titleList;</span><br><span class="line">        <span class="comment">// 蔵書一覧概要データリスト</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; summaryList;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// コンストラクタ</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReflectResult</span><span class="params">(JSONArray items)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// リストデータを初期化</span></span><br><span class="line">            titleList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            summaryList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="comment">// Jsonのパースエラーが発生した時に備えてtry~catchする</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">// 蔵書リストの件数分繰り返しタイトルをログ出力する</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; items.length(); i ++) &#123;</span><br><span class="line">                    <span class="comment">// 蔵書リストから i番目のデータを取得</span></span><br><span class="line">                    JSONObject item = items.getJSONObject(i);</span><br><span class="line">                    <span class="comment">// 蔵書のi番目データから蔵書情報のグループを取得</span></span><br><span class="line">                    JSONObject volumeInfo = item.getJSONObject(<span class="string">"volumeInfo"</span>);</span><br><span class="line">                    <span class="comment">// タイトルデータをリストに追加</span></span><br><span class="line">                    titleList.add(volumeInfo.getString(<span class="string">"title"</span>));</span><br><span class="line">                    <span class="comment">// 概要データをリストに追加</span></span><br><span class="line">                    summaryList.add(volumeInfo.getString(<span class="string">"description"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handlerから実行されるメソッド</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// ListViewに表示する情報をまとめるAdapterをインスタンス化</span></span><br><span class="line">            adapter = <span class="keyword">new</span> ResultListAdapter(ResultListActivity.<span class="keyword">this</span>, titleList, summaryList);</span><br><span class="line">            <span class="comment">// ListViewに表示情報をまとめたAdapterをセット</span></span><br><span class="line">            resultListView.setAdapter(adapter);</span><br><span class="line">            <span class="comment">// ListViewに行をクリックした時のイベントを登録</span></span><br><span class="line">            resultListView.setOnItemClickListener(ResultListActivity.<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上記コードが実装できたら動作確認します。<br>以下の様にGoogle Books APIにて取得した検索結果が表示されましたか？<br><img src="/AndroidCourse/android/07-AsyncProcess/reflectresult.png" width="300" title="Reflect Result"></p>
<p>今回の修正で<code>ResultListAdapter</code>クラスの変数がタイトルリストと概要リストの２つに増えたことで初期化時のコンストラクタで必要になる引数もタイトルと概要データの２つに増えました。<br>さらに<code>ResultListActivity</code>ではタイマースレッドでメインスレッドに戻った時の処理とは実装方法が違い、内部に新しく<code>Runnable</code>インターフェースを持ったクラスを作成し、<code>Handler</code>からメインスレッドに橋渡しをした際には作成したクラスに処理を実装しています。<br>新しく作成した”ReflectResult”クラスはコンストラクタでJSONデータのパースの続きを行い、全タイトルデータと全概要データを新しいリスト変数(titleList, summaryList)に代入しています。<br>そして全タイトルデータと全概要データを使ってListViewに表示する行データを作成する様に修正しました。</p>
<p>アプリは非同期通信を行い検索結果を取得してからリストを表示しているため、一時的に真っ白な画面が表示される様になりました、他のアプリでは真っ白になる時間をプログレスバーやローディングアニメーションにてユーザに読み込み中であることを伝えます。<br>ローディングアニメーションなどの実装方法は先のページで解説していきます。</p>
<h3><span id="layoutinflater-クラス">LayoutInflater クラス</span></h3><p>レイアウトXMLからViewやウィジェット等のオブジェクトを生成するためのクラス。<br><code>setContentView</code>以降で動的にViewを生成/表示する場合に利用します。<br>利用方法としては<strong>LayoutInflater</strong>を<code>from</code>メソッドにてインスタンス化し<code>inflate</code>メソッドを使用してレイアウトXMLを生成します。</p>
<ol>
<li><p>LayoutInflaterのインスタンス化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LayoutInflater li = LayoutInflater.from(context);</span><br></pre></td></tr></table></figure>
</li>
<li><p>LayoutInflaterを使ってViewを生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">View view = li.inflate(R.layout.layoutxml);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2><span id="入力文字列で蔵書検索する">入力文字列で蔵書検索する</span></h2><p>先ほどまでは決まった文字列(“ほんきで学ぶAndroidアプリ開発入門”)でしか検索できませんが、<br>動的に検索が行える様に、<code>MainActivity</code>の”EditText”で入力された文字列を<code>ResultListActivity</code>に渡しGoogle Books REST APIの検索条件になる様にプログラムを修正していきます。<br><figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...一部省略</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// コンソールログにボタンが押されたことを出力(表示)</span></span><br><span class="line">            Log.d(<span class="string">"BookSearchBtn"</span>, <span class="string">"onClick: BookSearch Button"</span>);</span><br><span class="line">            <span class="comment">// 入力された文字をToast(トースト)に表示</span></span><br><span class="line">            Toast.makeText(getBaseContext()</span><br><span class="line">                    , <span class="string">"入力された文字は ["</span> + bookSearchEditor.getText().toString() + <span class="string">"]です。"</span></span><br><span class="line">                    , Toast.LENGTH_LONG).show();</span><br><span class="line">            <span class="comment">// Timerスレッドを止める</span></span><br><span class="line">            timer.cancel();</span><br><span class="line">            <span class="comment">// 画面遷移するためのIntentをインスタンス化</span></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, ResultListActivity.class);</span><br><span class="line">            <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">            <span class="comment">// EditTextに入力された文字列を"KeyValuePair"でResultListActivityに渡す</span></span><br><span class="line">            intent.putExtra(<span class="string">"terms"</span>, bookSearchEditor.getText().toString());</span><br><span class="line">            <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">            <span class="comment">// 画面遷移アクションを実行</span></span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line">...一部省略</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><figcaption><span>ResultListActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultListActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">AdapterView</span>.<span class="title">OnItemClickListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// xmlファイルのコンポーネントと関連付ける要素</span></span><br><span class="line">    <span class="keyword">private</span> ListView resultListView;</span><br><span class="line">    <span class="comment">// ListViewの表示内容を管理するクラス</span></span><br><span class="line">    <span class="keyword">private</span> ResultListAdapter adapter;</span><br><span class="line">    <span class="comment">// OkHttp通信クライアント</span></span><br><span class="line">    <span class="keyword">private</span> OkHttpClient okHttpClient;</span><br><span class="line">    <span class="comment">// メインスレッドに戻ってくるためのHandler</span></span><br><span class="line">    <span class="keyword">private</span> Handler handler;</span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// MainActivityから渡されたデータを保持する</span></span><br><span class="line">    <span class="keyword">private</span> String term;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_result_list);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handlerをインスタンス化</span></span><br><span class="line">        handler = <span class="keyword">new</span> Handler();</span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// 画面遷移時のデータが空でない場合</span></span><br><span class="line">        <span class="keyword">if</span> (getIntent().hasExtra(<span class="string">"terms"</span>)) &#123;</span><br><span class="line">            <span class="comment">// Key:termsにデータがあればValueを代入</span></span><br><span class="line">            term = getIntent().getStringExtra(<span class="string">"terms"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 画面遷移時のデータがからの場合は "Android"と文字列を代入</span></span><br><span class="line">            term = <span class="string">"Android"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑追加↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// xmlファイルのコンポーネントと関連付け</span></span><br><span class="line">        resultListView = findViewById(R.id.ResultListView);</span><br><span class="line">        <span class="comment">// OkHttp通信クライアントをインスタンス化</span></span><br><span class="line">        okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        <span class="comment">// 通信するための情報</span></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// MainActivityで入力された文字列で検索する様修正</span></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder().url(<span class="string">"https://www.googleapis.com/books/v1/volumes?q="</span> + term).build();</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑修正↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">        ...一部省略</span><br><span class="line">    &#125;</span><br><span class="line">    ...一部省略</span><br></pre></td></tr></table></figure>
<p>上記コードを実装したら動作確認します。<br><code>MainActivity</code>で入力された文字列で検索した結果が表示される様になったでしょうか？<br>アプリ開発をしていると画面を分割したいけど、データを渡したい！！なんてことも出てくるので”画面遷移時にデータを渡せる”ということだけ覚えておけばインターネット上にも情報は沢山あるので見直して実装することができれば問題ありません。</p>
<p>多少インターネット通信中の真っ白な画面が不恰好ではありますが、検索結果を画面に一覧表示することができました。</p>
<h1><span id="プログラム課題">プログラム課題</span></h1><p>今回作成したプログラムでは検索処理を実行した際に漫画などの一部検索を行うとアプリが強制終了してしまうケースがあります。<br>原因は取得したデータの中に”description”というキーが存在せず、解析に失敗しているためです、これを解決するために、”description”データがあるかチェックする処理を追加し、”description”が存在しない場合は空文字データをリストに追加するようにプログラムを修正してください。</p>
<p><font color="red"><strong>ヒント</strong></font></p>
<ul>
<li>空文字をString変数に代入する方法は<code>変数名 = &quot;&quot;;</code>です</li>
<li>JSONObject内にキーが存在するかチェックするメソッドがあります<ul>
<li><code>JSONObject.has(&quot;key name&quot;);</code></li>
</ul>
</li>
</ul>
<p>解説は時間をおいて行います。</p>
<p>以上で<strong>蔵書検索機能の作成</strong>は完了です。<br>次の<a href="/AndroidCourse/android/08-AppDataBase">検索履歴一覧画面</a>の作成ではアプリ内データベースを使って検索した履歴一覧を表示する画面を作成します。</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">kuririnz</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-63175607-3');ga('send','pageview');</script></html>