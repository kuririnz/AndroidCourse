<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>非同期処理、REST API通信の実装 | Android programing getstart</title><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/normalize.css"><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/highlight.css"><link rel="stylesheet" type="text/css" href="/AndroidCourse//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="../../favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="../../." class="title">Android programing getstart</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="../../index.html" class="sidebar-nav-item">Home</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>非同期処理、REST API通信の実装</h1></div></div>
<article><div class="container post"><p>非同期処理の使い方と解説、APIを利用したインターネット通信処理ライブラリの実装と確認を行います</p>
<!-- toc -->
<ul>
<li><a href="#非同期処理">非同期処理</a><ul>
<li><a href="#非同期タイマー機能">非同期タイマー機能</a></li>
<li><a href="#handler-クラス">Handler クラス</a></li>
<li><a href="#runnable-クラス">Runnable クラス</a></li>
</ul>
</li>
<li><a href="#rest-api通信処理">REST API通信処理</a><ul>
<li><a href="#rest">REST</a></li>
<li><a href="#api">API</a></li>
<li><a href="#okhttpライブラリの導入">okHttpライブラリの導入</a></li>
<li><a href="#api通信機能">API通信機能</a></li>
</ul>
</li>
<li><a href="#まとめ">まとめ</a></li>
</ul>
<!-- tocstop -->
<p>当ページでは検索画面でボタンを押した後、蔵書/図書館検索の結果をAPIを利用して取得し、ログに出力するまでを解説します。<br><a href="/AndroidCourse/android/05-ButtonAction">前のページでは蔵書検索などボタンが押下された時の実装に関して解説しています</a><br>次のページで検索結果の表示、アプリ内データベースの利用に関して解説します。</p>
<h1><span id="非同期処理">非同期処理</span></h1><p>Androidアプリを開発するのに気を付けなければいけない概念として<strong>スレッド(Thread)</strong>という概念があります。<br>スレッドとは</p>
<blockquote>
<p>脈絡、筋道。電子メールなどでは、ある一つの話題に関連した投稿の集まり</p>
</blockquote>
<p>などの意味合いがあります。<br>身近なものでは飲み会や待ち合わせを行う時にLINEなどで作成したグループなどはスレッドと似ていると思います。</p>
<p>Androidのアプリが起動された時に画面に<code>activity_main.xml</code>のレイアウトが表示されるのも一つのスレッドでプログラムを実行された結果になります。</p>
<p>この画面にレイアウトを表示するスレッドを<strong>メインスレッド</strong>と呼びます。<br>メインスレッドは最初に表示されるアクティビティクラスを判別すると<font color="red">自動的に作成</font>されます。</p>
<p>メインスレッドはウィジェットやビューを更新、操作できる唯一のスレッドとなっているため<strong>UIスレッド</strong>と呼ばれることもあります。</p>
<p>非同期処理とは主に<strong>メインスレッド</strong>のプログラムには影響が無いようにプログラムを実行することを指します、<br>そのためにはメインスレッドに対して<strong>サブスレッド</strong>と呼ばれる別のスレッドを<font color="red">自分で作成</font>し、その中でプログラムを実行します。</p>
<h2><span id="非同期タイマー機能">非同期タイマー機能</span></h2><p>今回は非同期処理を学習するために、もともと準備されているタイマースレッドというサブスレッドを使って画面が表示されてから3秒ごとに、入力されたテキストをログ出力するプログラムを作っていきます。<br>プログラムは前回までのコードを元に修正していきます。<br><figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 蔵書検索ボタンをjavaプログラムで操作できるように名前をつける</span></span><br><span class="line">    bookSearchBtn = findViewById(R.id.BookSearchBtn);</span><br><span class="line">    <span class="comment">// 蔵書検索する文字を入力するEditTextをjavaプログラムで操作できるように名前をつける</span></span><br><span class="line">    bookSearchEditor = findViewById(R.id.BookSearchEdit);</span><br><span class="line">    <span class="comment">// 蔵書検索ボタンが押された時の処理を実装</span></span><br><span class="line">    View.OnClickListener bookSearchEvent = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// コンソールログにボタンが押されたことを出力(表示)</span></span><br><span class="line">            Log.d(<span class="string">"BookSearchBtn"</span>, <span class="string">"onClick: BookSearch Button"</span>);</span><br><span class="line">            <span class="comment">// 入力された文字をToast(トースト)に表示</span></span><br><span class="line">            Toast.makeText(getBaseContext()</span><br><span class="line">                    , <span class="string">"入力された文字は ["</span> + bookSearchEditor.getText().toString() + <span class="string">"]です。"</span></span><br><span class="line">                    , Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 蔵書検索ボタンが押された時に実行するプログラムをボタンに登録</span></span><br><span class="line">    bookSearchBtn.setOnClickListener(bookSearchEvent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// 準備されているTimerスレッドをインスタンス化</span></span><br><span class="line">    Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line">    <span class="comment">// 定期実行するタスク(TimerTask)をインスタンス化</span></span><br><span class="line">    TimerTask timerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// コンソールログに更新された内容を出力</span></span><br><span class="line">            Log.d(<span class="string">"SubThread Process"</span></span><br><span class="line">                    , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Timerスレッドの実行スケジュールを設定</span></span><br><span class="line">    <span class="comment">// 3秒毎にtimerTaskのプログラムを実行</span></span><br><span class="line">    timer.schedule(timerTask, <span class="number">0</span>, <span class="number">3000</span>);</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上記の追加プログラムが記述できたらエミュレータで確認してみてください。<br>Android Studioの<strong>Logcat</strong>で確認すると3秒毎にログが出力されていることがわかります。</p>
<p>次に画面が表示されてから3秒後から3秒毎にトーストを表示させてみましょう。<br><figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 蔵書検索ボタンが押された時に実行するプログラムをボタンに登録</span></span><br><span class="line">    bookSearchBtn.setOnClickListener(bookSearchEvent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 準備されているTimerスレッドをインスタンス化</span></span><br><span class="line">    Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line">    <span class="comment">// 定期実行するタスク(TimerTask)をインスタンス化</span></span><br><span class="line">    TimerTask timerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// コンソールログに更新された内容を出力</span></span><br><span class="line">            Log.d(<span class="string">"SubThread Process"</span></span><br><span class="line">                    , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span>);</span><br><span class="line">            <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">            <span class="comment">// 更新された内容をトーストに表示</span></span><br><span class="line">            Toast.makeText(getBaseContext()</span><br><span class="line">                    , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span></span><br><span class="line">                    , Toast.LENGTH_SHORT).show();</span><br><span class="line">            <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Timerスレッドの実行スケジュールを設定</span></span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// 画面が表示されてから3秒後から3秒毎にtimerTaskのプログラムを実行</span></span><br><span class="line">    timer.schedule(timerTask, <span class="number">3000</span>, <span class="number">3000</span>);</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上記のコードを入力したら<code>Run</code>ボタンを押して実行してみましょう。<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>・<br>アプリが強制終了してしまったのではないでしょうか？<br>最初に紹介した通りメインスレッド以外のスレッドでは画面を操作することができません。<br>上記で追加したコードはタイマースレッド内でToastを画面に表示する操作を実行しようとして強制終了してしまいました。<br>異常終了した際のエラーログはログ出力を行なっていた<code>Logcat</code>内に表示されているので確認してみましょう。<br><img src="/AndroidCourse/android/07-AsyncProcess/MainThreadError.png" title="ThreadSequence"></p>
<p>上記の通りエラーのメッセージ箇所は赤文字で表示されます。</p>
<p>今回のエラーの原因を説明している箇所は以下の一文</p>
<blockquote>
<font color="red">java.lang.RuntimeException: Can’t create handler inside thread that has not called Looper.prepare()</font>

</blockquote>
<p>以降の行で”at …”と説明されているのは実行されたプログラムが順に表示されます。。<br>各行後半の “()” 内はプログラムのファイル名とプログラムを実行した行数が表示され、クリックするとプログラムファイルが表示されます。<br>以下の行のエラーメッセージ上で “()” 内が青くなっていますが、これは自分で書いたプログラムファイルであることを表しており、<br>多くの場合にエラーの原因になったプログラムの行を示している箇所となります。</p>
<blockquote>
<font color="red">at kuririnz.xyz.bookdiscovery.MainActivity$2.run(</font><font color="blue">MainActivity.java:53</font><font color="red">)</font>

</blockquote>
<p>今後エラーが発生した時に原因や問題を解析する時にはまずここを見るよう癖付けましょう！</p>
<p>タイマースレッド(サブスレッド)で画面操作できないことを確認できました、今度は正常にトーストが画面に表示されるように修正していきましょう。<br>コードを修正する前に新しく使う<strong>Handlerクラス</strong>と<strong>Runnableクラス</strong>を紹介します。</p>
<h2><span id="handler-クラス">Handler クラス</span></h2><p>Handlerクラスはスレッドから別のスレッドへ通信を行う機能を持ったクラスです。<br>今回のプログラムではToastを画面に表示する為TimerThreadからMainThreadへ通信を行います。<br>通信とは記述していますが、今回の通信ではMainThreadでToastを表示することが目的になるため、<br>データを渡すことが目的の通信では無いことを意識してみてみてください。</p>
<h2><span id="runnable-クラス">Runnable クラス</span></h2><p>Runnableクラスは実際にThreadで処理するプログラムを実行するためのクラスです。<br><strong>Thread = Runnable</strong>と認識して問題ありません。<br>今回のプログラムではTimerThreadで３秒ごとにlogを出力する時、MainThreadでToastを表示する処理を実行する時にRunnableクラスを使用しています。</p>
<figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// レイアウトxmlと関連付けるWidget</span></span><br><span class="line">    Button bookSearchBtn;</span><br><span class="line">    EditText bookSearchEditor;</span><br><span class="line">    <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">    <span class="comment">// メインスレッドに帰って来るためのハンドラー</span></span><br><span class="line">    Handler handler;</span><br><span class="line">    <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓追加↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">        <span class="comment">// ハンドラーオブジェクトをMainThreadでインスタンス化</span></span><br><span class="line">        handler = <span class="keyword">new</span> Handler();</span><br><span class="line">        <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">        <span class="comment">// 蔵書検索ボタンをjavaプログラムで操作できるように名前をつける</span></span><br><span class="line">        bookSearchBtn = findViewById(R.id.BookSearchBtn);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定期実行するタスク(TimerTask)をインスタンス化</span></span><br><span class="line">        TimerTask timerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// コンソールログに更新された内容を出力</span></span><br><span class="line">                Log.d(<span class="string">"SubThread Process"</span></span><br><span class="line">                        , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span>);</span><br><span class="line">                <span class="comment">//↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓修正↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></span><br><span class="line">                handler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 更新された内容をトーストに表示</span></span><br><span class="line">                        Toast.makeText(getBaseContext()</span><br><span class="line">                                , <span class="string">"「"</span> +  bookSearchEditor.getText().toString() + <span class="string">"」に更新されました。"</span></span><br><span class="line">                                , Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">//↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上記コードを実装できたら、エミュレータで動作確認してみましょう。<br>以下の様に3秒ごとに入力中の文字がToastに表示されたでしょうか？<br><img src="/AndroidCourse/android/07-AsyncProcess/AsyncTimerToast.png" width="300" title="TimerThreadTest"></p>
<p>実際に使ってみたHandlerクラスですが、正しくMainThreadで実行するにはコツが必要です、<br>コツというのはHandlerクラスをインスタンス化するタイミングです。<br>深く理解できればこのタイミングの調整は不要になりますが、全てを一度に覚えきるのは難しいです、<br>ですので他の非同期処理後にMainThreadで処理を行うのにHandlerを利用する場合はまず、<strong>onCreateメソッドのsetContetView(…)</strong>の次行でインスタンス化するよう意識付けてください。</p>
<blockquote>
<p>※サブスレッド間の通信に関してはこの一連の記事では紹介していないので別途調査が必要です。</p>
</blockquote>
<p>以上で、非同期処理の基礎の解説は終了です、難しい箇所も多いので自分なりにプログラムを修正して試してみましょう。<br>続いてはインターネット通信処理を通しでデータを取得するAPIの使い方を実装していきます。</p>
<h1><span id="rest-api通信処理">REST API通信処理</span></h1><p>非同期処理が作れる様になったらインターネット上にあるデータを取得するプログラムを作っていきます、<br>そのためにはインターネット上にあるデータを開発するアプリから取得して使う方法があります。<br>これを多くの場合にAPI通信などと呼びます。</p>
<p>今回のアプリでは蔵書を検索する機能を実装するためにこのAPI通信が必要になります。</p>
<p>REST APIとは<strong>Representational State Transfer Application Programming Interface</strong>の略称で<br>それぞれ”REST”と”API”で使われることもあります。</p>
<h2><span id="rest">REST</span></h2><p>Webサービスの設計モデルを表しており、REST APIのURLにHTTPメソッドでアクセスすることでデータの送受信が行えます。</p>
<p>RESTの設計条件として以下が該当します。<br><blockquote><ul>
<li>アドレス指定可能なURLで公開されていること</li>
<li>インターフェースが統一されていること(HTTPメソッドに準じていること)</li>
<li>ステートレスであること</li>
<li>処理結果がHTTPステータスコードで通知されること</li>
</ul>
<footer><strong>Qiita</strong><cite><a href="https://qiita.com/TakahiRoyte/items/949f4e88caecb02119aa" target="_blank" rel="external">REST入門 基礎知識</a></cite></footer></blockquote></p>
<h2><span id="api">API</span></h2><p>ウィキペディアには以下の様にあります。</p>
<font color="red"><strong>ソフトウェアコンポーネントが互いにやり取りするのに使用するインターフェース仕様</strong></font>

<p>…文章からイメージするのは難しそうです。。。<br>ですので、まずは以下の様な認識で使っていきましょう。</p>
<font color="blue"><strong>インターネット上に公開された、URLを知っていれば誰でも使えるデータ</strong></font>

<p>例として実際にAPIのデータをgoogle ChromeなどWebブラウザの画面で確認できるもので確認してみましょう。<br>以下のurlはgoogleが一般公開している”google books API”というAPIで、蔵書の情報を取得するAPIです。<br><blockquote><p><a href="https://www.googleapis.com/books/v1/volumes" target="_blank" rel="external">https://www.googleapis.com/books/v1/volumes</a></p>
<footer><strong>Google Books APIs</strong><cite><a href="https://developers.google.com/books/docs/v1/using" target="_blank" rel="external">Reference</a></cite></footer></blockquote><br>この画面に表示されているデータは<code>json</code>という形式でまとめられたデータになっており、上記urlにアプリからアクセスすると<br>画面に表示されているデータをアプリで受け取ることができます。<br>多くのアプリではこの様にデータを取得して画面に表示させてキュレーションアプリなどが開発されています。</p>
<p>次に指定の本を検索してみましょう、Webブラウザのurlに少し付け加えてみます。<br>先ほどと結果の違いがわかる様に新しくタブを開いて以下のurlを表示してみましょう。</p>
<blockquote>
<p><a href="https://www.googleapis.com/books/v1/volumes?q=ほんきで学ぶAndroidアプリ開発入門" target="_blank" rel="external">https://www.googleapis.com/books/v1/volumes?q=ほんきで学ぶAndroidアプリ開発入門</a></p>
</blockquote>
<p>Webブラウザを確認すると、表示される内容が変わっているのがわかります。<br>追加した、”?q=ほんきで学ぶAndroidアプリ開発入門”と文字の部分一致で検索した結果が表示されました。</p>
<p>Webブラウザで結果を確認していただいた通り、APIというのはURLや設定されているパラメータの値によって検索結果が変わります、<br>これはホームページと同じくサーバにURLが届き、サーバ内のプログラムが実行された結果<code>json</code>データが返されているからです。</p>
<p>上記で紹介したAPIの検索条件等は<a href="https://developers.google.com/books/docs/v1/using#WorkingVolumes" target="_blank" rel="external">Google Books APIs</a>に記載されています。（全て英語です）</p>
<p>下図はAPII通信を行うプログラムの流れとして、<br>API通信を行う流れからデータを取得し、画面に反映するまでの簡単な流れを図にしています。<br><img src="/AndroidCourse/android/07-AsyncProcess/APISequence.svg" width="550" title="APISequence"></p>
<p>上記で解説していた非同期処理ですが、こちらでも利用します。<br>むしろAPI通信を行いデータを画面に反映するために使用すること多い気がします。</p>
<p>というのもAndoridアプリ開発の上で画面更新はMainThreadのみ可能と解説をしましたが、更に<font color="blue"><strong>MainThreadは時間のかかる処理を行なってはいけない</strong></font>という制約もあるため、MainThreadでネットワーク通信を行うとアプリが強制終了してしまいます。<br>（サブスレッドで画面を操作しようとした時と同じ様に終了します）</p>
<p>上記の図の通りですが<font color="red"><strong>API通信を実行し、画面に反映するためには大まかに以下の手順が必要になります</strong></font></p>
<ol>
<li>メインスレッドでハンドラーをインスタンス化</li>
<li>メインスレッドからサブスレッドを起動</li>
<li>サブスレッドでAPI通信処理を実行</li>
<li>ハンドラーを使いサブスレッドで取得したAPIデータをメインスレッドへ連携</li>
<li>メインスレッドでAPIデータを使い画面を操作</li>
</ol>
<h2><span id="okhttpライブラリの導入">okHttpライブラリの導入</span></h2><p>API通信、ネットワーク通信処理を行うために、ここでは<strong>okHttp</strong>という<em>ライブラリ</em>を使っていきます、<strong>okHttp</strong>はAndroid に元々備わっているネットワーク通信機能をさらに簡単に行うことができるようになる機能群です。<br>このようにプログラムを一部簡単にしてくれる機能群を<em>ライブラリ</em>と呼びます。</p>
<p>修正するファイルは<code>build.gradle</code>というファイルです、このファイルは２つあると思います、開くのは<code>build.gradle</code>の後ろに<strong><em>(Module: app)</em></strong>と表示されている方を開いてください。<br><img src="/AndroidCourse/android/07-AsyncProcess/includeokHttp01.png" width="550" title="IncludeokHttp"></p>
<p>続いて<code>build.gradle</code>の “dependencies” の “{}”内に以下のコードを記述します<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;com.squareup.okhttp3:okhttp:3.9.1&apos;</span><br></pre></td></tr></table></figure></p>
<p>コードの記述が終わったら右上に表示された<font color="blue">Sync Now</font>リンクをクリックします。<br><img src="/AndroidCourse/android/07-AsyncProcess/includeokHttp02.png" width="600" title="Include okHttp"></p>
<p>これで<strong>okHttp</strong>ライブラリの導入は完了です。</p>
<h2><span id="api通信機能">API通信機能</span></h2><h1><span id="まとめ">まとめ</span></h1><p>非同期通信やスレッドに関する概念は最初イメージするのが難しく整理しにくい内容だと思いますが、以下のポイントだけ<br>抑えておきましょう！</p>
<ul>
<li>Androidアプリ開発においては画面の更新、操作を行う場合はメインスレッドを使う必要がある</li>
<li>Androidアプリ開発ではネットワーク通信処理を行う場合はサブスレッド（メインスレッド以外）で行う必要がある</li>
<li>Threadクラスはインスタンス化したスレッドと同じスレッドとして処理を行うことができる</li>
<li>HandlerクラスはThreadを起動させる時に利用する</li>
</ul>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">kuririnz</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>